{% extends "base.html" %}

{% block title %}我的成绩 - 学生信息管理系统{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h1>我的成绩</h1>
        <div>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> 返回仪表板
            </a>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if grades %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>课程代码</th>
                        <th>课程名称</th>
                        <th>成绩</th>
                        <th>学分</th>
                        <th>学期</th>
                        <th>考试日期</th>
                    </tr>
                </thead>
                <tbody>
                    {% for grade in grades %}
                    <tr>
                        <td>{{ grade.course.course_code }}</td>
                        <td>{{ grade.course.course_name }}</td>
                        <td>
                            <span class="badge {% if grade.score >= 90 %}bg-success{% elif grade.score >= 80 %}bg-info{% elif grade.score >= 70 %}bg-primary{% elif grade.score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ grade.score }}
                            </span>
                        </td>
                        <td>{{ grade.course.credit }}</td>
                        <td>{{ grade.semester }}</td>
                        <td>{{ grade.exam_date.strftime('%Y-%m-%d') if grade.exam_date else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 统计信息 -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title">成绩统计</h5>
                        <div class="row">
                            <div class="col-6">
                                <p>平均分: <strong>{{ "%.2f"|format((grades | map(attribute='score') | sum) / (grades | length)) }}</strong></p>
                                <p>最高分: <strong>{{ grades | map(attribute='score') | max }}</strong></p>
                            </div>
                            <div class="col-6">
                                <p>最低分: <strong>{{ grades | map(attribute='score') | min }}</strong></p>
                                <p>总学分: <strong>{{ grades | map(attribute='course') | map(attribute='credit') | sum }}</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title">成绩分布</h5>
                        <div class="progress mb-2" style="height: 25px;">
                            {% set excellent = grades | selectattr('score', '>=', 90) | list | length %}
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ (excellent / grades | length * 100) | round(1) }}%">
                                优秀 (90-100): {{ excellent }}
                            </div>
                        </div>
                        <div class="progress mb-2" style="height: 25px;">
                            {% set good = grades | selectattr('score', '>=', 80) | selectattr('score', '<', 90) | list | length %}
                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ (good / grades | length * 100) | round(1) }}%">
                                良好 (80-89): {{ good }}
                            </div>
                        </div>
                        <div class="progress mb-2" style="height: 25px;">
                            {% set average = grades | selectattr('score', '>=', 70) | selectattr('score', '<', 80) | list | length %}
                            <div class="progress-bar bg-primary" role="progressbar" style="width: {{ (average / grades | length * 100) | round(1) }}%">
                                中等 (70-79): {{ average }}
                            </div>
                        </div>
                        <div class="progress mb-2" style="height: 25px;">
                            {% set pass = grades | selectattr('score', '>=', 60) | selectattr('score', '<', 70) | list | length %}
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ (pass / grades | length * 100) | round(1) }}%">
                                及格 (60-69): {{ pass }}
                            </div>
                        </div>
                        <div class="progress" style="height: 25px;">
                            {% set fail = grades | selectattr('score', '<', 60) | list | length %}
                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ (fail / grades | length * 100) | round(1) }}%">
                                不及格 (<60): {{ fail }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> 暂无成绩信息
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}